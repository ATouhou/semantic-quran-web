<html>
	<head>
		<title>Symantic Quran</title>
		<meta name="viewport" content="initial-scale=0.25">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.js"></script>
		<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.css" />
		<style type="text/css">
			.clear {
				clear: both;
			}
			.ui-page { 			
				background: -webkit-linear-gradient(#A4BCC2, #DADADA); /* For Safari 5.1 to 6.0 */
  				background: -o-linear-gradient(#A4BCC2, #DADADA); /* For Opera 11.1 to 12.0 */
 			 	background: -moz-linear-gradient(#A4BCC2, #DADADA); /* For Firefox 3.6 to 15 */
  				background: linear-gradient(#A4BCC2, #DADADA); /* Standard syntax */
			}
			.header {
				width: 100%;
				padding-bottom: 10px;
				border: 1px solid black;
				text-shadow: none;
    			border-radius: 0 0 50px 50px;
				border-bottom-width: 0px;
				text-align: center;
				
				background: -webkit-linear-gradient(#2A6F6C, #339D79); /* For Safari 5.1 to 6.0 */
  				background: -o-linear-gradient(#2A6F6C, #339D79); /* For Opera 11.1 to 12.0 */
 			 	background: -moz-linear-gradient(#2A6F6C, #339D79); /* For Firefox 3.6 to 15 */
  				background: linear-gradient(#2A6F6C, #339D79); /* Standard syntax */
			}
			.header h1 {
				font-size: 40px;
				padding: 5px 0 0 20px;
				margin: 0;
			}
			.header h2 {
				font-size: 20px;
				padding: 0 0 0 20px;
				margin: 0;
			}
			#contentBody {
				text-shadow: none;
				margin-bottom: 20px;
			}
			#contentArea {
				width: 80%;
				margin: 0 auto;
			}
			#browseArea .ui-select,
			#searchArea .ui-input-search {
				width: 45%;
				float: left;
			}
			#viewButton,
			#searchButton {
				width: 30%;
				float: left;
				margin: 7px;
			}
			#searchButton {
				margin-top: 10px;
			}
			.sidePanel {
				border-bottom: 1px solid black;
				padding: 0 10px 10px 10px;
				
				background: -webkit-linear-gradient(#339D79, #56D27A); /* For Safari 5.1 to 6.0 */
  				background: -o-linear-gradient(#339D79, #56D27A); /* For Opera 11.1 to 12.0 */
 			 	background: -moz-linear-gradient(#339D79, #56D27A); /* For Firefox 3.6 to 15 */
  				background: linear-gradient(#339D79, #56D27A); /* Standard syntax */
			}
			.sidePanel h3 {
				margin: 15px 0 10px 0;
				font-size: 15px;
			}
			.sidePanel button {
				margin: 5px 0px;
				padding: 5px 8px;
			}
			.sidePanel .ui-block-a,
			.sidePanel .ui-block-b {
				width: 30%;
			}
			.sidePanel .ui-block-c,
			.sidePanel .ui-block-d {
				width: 20%;
			}
			.tagGroupHeader {
				padding-left: 10px;
			}
			.resultsPane {
			}
			.resultsPane .ui-block-a {
				width: 88%;
			}
			.resultsPane .ui-block-b {
				width: 12%;
			}
			.result .ayahWrapper {
				background-color: beige;
				border: 1px solid black;
				border-top-width: 0;
				text-align: right;
				padding: 10px;
				
				background: -webkit-linear-gradient(left, #F3FCEB , #E3E5CD); /* For Safari 5.1 to 6.0 */
  				background: -o-linear-gradient(right, #F3FCEB, #E3E5CD); /* For Opera 11.1 to 12.0 */
  				background: -moz-linear-gradient(right, #F3FCEB, #E3E5CD); /* For Firefox 3.6 to 15 */
  				background: linear-gradient(to right, #F3FCEB , #E3E5CD); /* Standard syntax */
			}
			.result .ayah {
				font-size: 35px;
			}
			.result .ayahRef {
				font-size: 25px; 
				padding-left: 10px;
				float: left;
			}
			.result .translation {
				font-size: 15px;
				padding-top: 5px;
			}
			ul{
				padding: 0;
				margin: 0;
			}
			li.tag {
				display: inline-block;
				list-style-type: none;
				border: 1px solid gray;
				border-radius: 10px;
				background-color: beige;
				cursor: pointer;
				padding: 5px;
				margin: 1px;
				font-size: 10px;
			}
			li.addTag {
				background-color: lightgreen;
			}
			span.delete {
				padding-left: 5px;
				color: red;
			}
			.resultsPane ul {
				margin-top: 10px;
				float: right;
			}
			audio {
				padding-top: 5px;
				float: left;
				width: 40px;
			}
			#recentlyAddedTags {
				max-width: 300px;
				margin: 0 auto;
				padding: 10px;
			}
			#addTagDialogButton {
				max-width: 250px;
				margin: 0 auto;
			}
			#loadMore {
				display: none;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>Semantic Quran</h1>
			<h2>Browse and search the Quran based on tags and semantic themes</h2>
		</div>
		<div id="contentBody">
			<div id="contentArea">
				<div class="sidePanel ui-grid-c">
					<div id="browseArea" class="ui-block-a">
						<h3>Browse Ayat</h3>
						<!--<label for="surahSelect" class="select">Surah</label>-->
						<select name="surahSelect" id="surahSelect" data-mini="true" data-inline="true">
							<option value="1">Al-Fatihah</option>
						</select>						
					</div>
					<div id="searchArea" class="ui-block-b">
						<h3>Search Tags</h3>
						<!-- <label for="search-1">Search for a topic in the Quran. Results are crowd sourced and are constantly being improved.</label> -->
						<input type="search" name="search-tag" id="search-tag" value="praise-of-Allah">
						<button id="searchButton" type="button">Search</button>
					</div>
					<div id="suggestedTags" class="tagGroupHeader ui-block-c">
						<h3>Suggested Tags</h3>
						<ul>
							<li class="tag">
								<span class="tagName">marriage</span>
							</li>
							<li class="tag">
								<span class="tagName">worship</span>
							</li>
							<li class="tag">
								<span class="tagName">dua</span>
							</li>
							<li class="tag">
								<span class="tagName">shaytan</span>
							</li>
							<li class="tag">
								<span class="tagName">jinn</span>
							</li>
							<li class="tag">
								<span class="tagName">heaven</span>
							</li>
							<li class="tag">
								<span class="tagName">magic</span>
							</li>
							<li class="tag">
								<span class="tagName">hell</span>
							</li>
						</ul>
					</div>
					<div id="lastUsedTags" class="tagGroupHeader ui-block-d">
						<h3>Last Used Tags</h3>
						<ul></ul>
					</div>
				</div>
				<div class="resultsPane"></div>
				<button id="loadMore" type="button">Load more</button>
			</div>
		</div>
		<!-- Github ribbon -->
		<a id="ribbon" href="https://github.com/hasankhan/semantic-quran-web"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

		<a id="dialogLink" href="#addTagDialog" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a"
		data-transition="pop" style="display: none">Add a Tag</a>
		<div data-role="popup" id="addTagDialog" class="ui-corner-all">
			<div style="padding:10px 20px;">
				<h3>Please contribute a thoughtful tag for this ayah.</h3>
				<input type="text" name="tagName" value="" id="addTagDialogTextBox" placeholder="(ex: Mercy-of-Allah)">
				<ul id="recentlyAddedTags"></ul>
				<button id="addTagDialogButton" type="button" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check">Add</button>
			</div>
		</div>
		
		<script type="text/javascript">
			var tagsMRU = [];
			var tagsRecentlyAdded = [];
			var context = null;
			
			function doAddTag(val, surahNum, verseNum) {
				var deferred = $.Deferred();
				
				console.log("Adding tag: " + val + " to " + "[" + surahNum + ":" + verseNum + "]");
				
				var promise = $.ajax({          
		            type:  'POST',
		            url:   "http://semantic-quran.azure-mobile.net/api/tag",
		            dataType: 'json',
					data: {
						tag: val,
						surah: surahNum,
						verse: verseNum
					}
		         });
				 
				// Add the tag to our recently added tags
				var isInList = false;
				$.each(tagsRecentlyAdded, function(i, entry) {
					if(entry === val){
						isInList = true;
						return false;
					}
				});
				
				if(!isInList) {
					tagsRecentlyAdded.unshift(val);
					tagsRecentlyAdded = tagsRecentlyAdded.slice(0, 10);
					updateRecentlyAddedTags();
				}
				 
				 return promise;
			}
			
			function doDeleteTag(val, surahNum, verseNum) {
				console.log("Deleting tag: " + val + " to " + "[" + surahNum + ":" + verseNum + "]");
				
				$.ajax({          
		            type:  'DELETE',
		            url:   "http://semantic-quran.azure-mobile.net/api/tag/" + val + "/" + surahNum + "/" + verseNum,
		            dataType: 'json',
		            success: function() {
						console.log("Successfully Deleted")
		            }
		         });
			}
			
			function updateMRU() {
				var container = $('#lastUsedTags ul').empty();
				$.each(tagsMRU, function(i, tag) {
					var tagElement = $("<li class='tag'></li>").appendTo(container);
					tagElement.append('<span class="tagName">' + tag + '</span>');
				});
				
				if(typeof(Storage) !== "undefined") {
					localStorage.tagsMRU = JSON.stringify(tagsMRU);
				}
			}
			
			function updateRecentlyAddedTags() {
				var container = $('#recentlyAddedTags').empty();
				$.each(tagsRecentlyAdded, function(i, tag) {
					var tagElement = $("<li class='tag recentTag'></li>").appendTo(container);
					tagElement.append('<span class="tagName">' + tag + '</span>');
				});
				
				if(typeof(Storage) !== "undefined") {
					localStorage.tagsRecentlyAdded = JSON.stringify(tagsRecentlyAdded);
				}
			}
		
			function doSearch(val) {
				window.lastSurah = null;
				window.enableAutoScroll = false;
				$('#loadMore').hide();
                
				console.log("Doing search for: " + val);
				var resultPane = $('.resultsPane').empty();
		
		        $.ajax({          
		            type:  'GET',
		            url:   "http://semantic-quran.azure-mobile.net/api/tag/" + val,
		            dataType: 'json',              
		            success: function(data) {
						if (data && data.length > 0) {
							loadResults(data, true);
						}
		            }
		         });
		
				// Add the search to our recent searches
				var isInList = false;
				$.each(tagsMRU, function(i, entry) {
					if(entry === val){
						isInList = true;
						return false;
					}
				});
				
				if(!isInList) {
					tagsMRU.unshift(val);
					tagsMRU = tagsMRU.slice(0, 7);
					updateMRU();
				}
			}
			
			function doViewPassage(surah, ayahStart, ayahEnd) {
				window.enableAutoScroll = true;
				
				var resultPane = $('.resultsPane').empty();				
				loadVerses(surah, ayahStart, ayahEnd, true);
				
				window.surah= surah;
				window.ayahStart = ayahStart || 1;
				window.ayahEnd = ayahEnd || 50;
			}
									
			$(function(){									
				$(window).scroll(function() {
				   if($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
				       scrollMore();
				   }
				});
                
                $('#loadMore').click(scrollMore);
				
				function scrollMore() {
					if (!window.enableAutoScroll) {
						return;
					}
					
				   window.ayahStart+=50;
				   window.ayahEnd+=50;
				   loadVerses(window.surah, window.ayahStart, window.ayahEnd, false);
				}							
			});
			
			function loadVerses(surah, start, end, animate) {				
				window.loading = true;
				var url = "";
				if (start && end) {
					url = "http://semantic-quran.azure-mobile.net/api/verse/" + surah + "/" + start + "-" + end;
				}
				else {
					url = "http://semantic-quran.azure-mobile.net/api/verse/" + surah;
				}
				
		        $.ajax({          
		            type:  'GET',
		            url:  url,
		            dataType: 'json',              
		            success: function(data) {
						if (data && data.length > 0) {
							loadResults(data, animate);
							if (data.length < 50) {
								$('#loadMore').hide();
							}
							else {
								$('#loadMore').show();
							}
						}
		            }
		         });
			}
		
			function loadResults(data, animate) {
				$.each(data, function(i, row) {
					var resultPane = $('.resultsPane');
					var result = $('<div class="result">');
					if (animate) {
						result.fadeIn("slow")
					}
					result.appendTo(resultPane);
					var wrapper = $('<div class="ayahWrapper">')
						.appendTo(result);
					var ayahRef = $('<div class="ayahRef"></div>')
						.text('[' + row.surah + ':' + row.verse + ']')
						.appendTo(wrapper);
					var ayah = $('<div class="ayah"></div>')
						.text(row.quran.text)
						.appendTo(wrapper);
					var translation = $('<div class="translation"></div>')
						.text(row.content[0].text)
						.appendTo(wrapper);
					var tagGroup = $('<ul></ul>')
						.appendTo(wrapper);
		
					var audioPlayer = $(
						'<audio controls preload="none">' +
		  					'<source src="' + row.audio.mp3.url + '" type="audio/mpeg">' +
		  					'<source src="' + row.audio.ogg.url + '" type="audio/ogg">' +
						'</audio>').appendTo(wrapper);
					$("<div class='clear'>").appendTo(wrapper);
					
					window.lastPlayer;		
					audioPlayer.on('play', function() {
						if (window.lastPlayer) {
							if (window.lastPlayer.pause) {
								window.lastPlayer.pause();
							}
							if (window.lastPlayer[0] && window.lastPlayer[0].pause) {
								window.lastPlayer[0].pause();
							}
							window.lastPlayer.css('width', '40px');
						}
						window.lastPlayer = $(this)
						window.lastPlayer.css('width', '200px');
					});			
		
					// Add all the tags to the row
					$.each(row.tags, function (j, tag) {
						var tagElement = $("<li class='tag'></li>").prependTo(tagGroup);
						tagElement.append('<span class="tagName">' + tag + '</span>');
						
						var deleteElement = $('<span class="delete">x</span>')
							.attr("tag", tag)
							.attr("surah", row.surah)
							.attr("verse", row.verse);
							
						tagElement.append(deleteElement);
					});
					
					var addButton = $('<li class="addTag tag">')
						.text("+")
						.attr("surahNum", row.surah)
						.attr("verseNum", row.verse)
						.appendTo(tagGroup);
				});
				
				if (animate) {
					window.scroll(0, 0);
				}
			}			
			
			window.lastSurah = null;
			function onSurahChanged() {
					var surah = $("#surahSelect").val();
					if (surah == window.lastSurah) {
						return;
					}
					window.lastSurah = surah;
					var ayahStart = $("#ayahStartSelect").val();
					var ayahEnd = $("#ayahEndSelect").val();
					doViewPassage(surah, ayahStart, ayahEnd);
			}
			
			(function initializeSurahDropdowns() {
				var surahSelector = $("#surahSelect");
				surahSelector.click(onSurahChanged);
		        $.ajax({          
		            type:  'GET',
		            url:   "http://semantic-quran.azure-mobile.net/api/surah",
		            dataType: 'json',
		            success: function(data) {
						if (data && data.length > 0) {
							surahSelector.empty();
							
							$.each(data, function (i, surahData) {
								var surahEntry = $('<option value="' + surahData.id + '">' + surahData.id + ': ' + surahData.name.simple + '</option>').appendTo(surahSelector);
							});
						}
		            }
		         });
			})();
		
			$(function () {
				$("#contentBody").on("click", ".tag", function() {
					var $this = $(this);
		
					if (!$this.hasClass("addTag") && !$this.hasClass("recentTag")) {
						var val = $(".tagName", $this).text();
						doSearch(val);
					}
				});
				
				$("#contentBody").on("click", "span.delete", function() {
					var $this = $(this);
					var tag = $this.attr("tag");
					var surah = $this.attr("surah");
					var verse = $this.attr("verse");
					var parent = $this.parent().remove(); 
					doDeleteTag(tag, surah, verse);
					
					return false;
				});
				
				$("#addTagDialogButton").click(function () {
					var $textBox = $("#addTagDialogTextBox");
					var tags = $textBox.val();
					var surahNum = context.attr("surahNum");
					var verseNum = context.attr("verseNum");
					
					$textBox.val('');
					
					if (tags != null && tags.length>0) {
						var values = tags.split(/[,;]/);
						$.each(values, function (i, value) {
							doAddTag(value, surahNum, verseNum).done(function (val) {
								console.log("Successfully Added: " + val.text);
								
								// Update the local row
								var tagGroup = context.parent();					
								var tagElement = $("<li class='tag'></li>").prependTo(tagGroup);
								tagElement.append('<span class="tagName">' + val.text + '</span>');
								
								var deleteElement = $('<span class="delete">x</span>')
									.attr("tag", val.text)
									.attr("surah", surahNum)
									.attr("verse", verseNum);
									
								tagElement.append(deleteElement);
							});
						});				
					}
					
					$("#addTagDialog").popup("close");					
					return false;
				});
				
				$("#contentBody").on("click", ".addTag", function() {
					context = $(this);
					var textBox = $("#addTagDialogTextBox").val(""); 
					var dialog = $("#dialogLink").click();
					setTimeout(function () {
						textBox.focus();
					}, 500);
				});
				
				$("#recentlyAddedTags").on("click", ".recentTag", function() {
					var $this = $(this);
					var $textBox = $("#addTagDialogTextBox");
					var val = $(".tagName", $this).text();
                    var existing = $textBox.val();
                    if (existing) {
                        val = existing + ',' + val;
                    }
					$textBox.val(val);
				});
				
				$("#searchButton").click(function() {
					var val = $("#search-tag").val();
					
					if (val && val.length > 0) {
						doSearch(val);
					}
				});
				
				(function onSurahChanged() {
					var surah = $("#surahSelect").val();
					var ayahStart = $("#ayahStartSelect").val();
					var ayahEnd = $("#ayahEndSelect").val();
					doViewPassage(surah, ayahStart, ayahEnd);
				})();
				
				if(typeof(Storage) !== "undefined") {
					tagsMRU = JSON.parse(localStorage.tagsMRU);
					tagsRecentlyAdded = JSON.parse(localStorage.tagsRecentlyAdded);
					updateMRU();
					updateRecentlyAddedTags();
				}
			});
		</script>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		  ga('create', 'UA-29293370-3', 'auto');
		  ga('require', 'displayfeatures');
		  ga('send', 'pageview');		
		</script>
		<script src='http://ajax.aspnetcdn.com/ajax/mobileservices/MobileServices.Web-1.1.2.min.js'></script>
		<script>
			var client = new WindowsAzure.MobileServiceClient('https://semantic-quran.azure-mobile.net/', 'okajHbuHsfhRmylXmwQgOKAsnmUyKG49');
			$(function(){
				var loginBtn = $("#login");
				loginBtn.click(function(){
					client.login("facebook").done(function (results) {
						loginBtn.hide();
				    }, function (err) {
				         alert("Error: " + err);
				    });
				});
			});			
		</script>
		<button id="login">Login with Facebook</button>
	</body>
</html>